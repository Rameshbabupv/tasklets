# Beads Import Script

This script imports epics, features, and tasks from Beads CLI (`.beads/issues.jsonl`) into the Tasklets application database.

## Prerequisites

Before running the import, make sure:

1. **PostgreSQL is running** and accessible at the configured connection string
2. **Database schema is up-to-date**: `npm run db:push`
3. **Tasklets product exists** in the database (created via app UI)
4. **ramesh@systech.com user exists** in the database (created via app or seed)
5. **`.beads/issues.jsonl`** file exists at the repo root (generated by `bd export`)

## How It Works

### Data Flow

```
.beads/issues.jsonl â†’ Parse JSONL â†’ Map fields â†’ Insert into DB
    â†“
    Epics â†’ features (via epicId)
            â†’ tasks (via featureId)
```

### Field Mappings

| Beads | Tasklets | Notes |
|-------|----------|-------|
| `id` | `beadsId` | Unique identifier for future sync |
| `title` | `title` | Issue title |
| `description` | `description` | Full description |
| `issue_type` | `type` | epic/feature/task (â†’ features/epics/dev_tasks) |
| `status` | `status` | See status mapping below |
| `priority` | `priority` | P0-P4 â†’ 0-4 (numeric) |
| `labels` | `labels` | Array of tags |
| `created_at` | `createdAt` | ISO timestamp |
| `closed_at` | `closedAt` | ISO timestamp (only if closed) |

### Status Mapping

| Beads Status | Tasklets Status | Notes |
|--------------|-----------------|-------|
| `open` | `backlog` | Not started |
| `in_progress` | `in_progress` | Active work |
| `closed` | `completed` | Finished |
| Other | `backlog` | Default fallback |

### Priority Mapping

| Beads | Tasklets |
|------|----------|
| P0 | 0 (Critical) |
| P1 | 1 (High) |
| P2 | 2 (Medium) |
| P3 | 3 (Low) |
| P4 | 4 (Backlog) |

### Ownership & Hierarchy

- **Owner**: All items assigned to `ramesh@systech.com`
- **Product**: All items linked to "Tasklets" product
- **Hierarchy**:
  - Epics are standalone
  - Features are linked to parent Epic (via `epicId`)
  - Tasks are linked to parent Feature (via `featureId`)
  - Parent links determined from Beads `dependencies` field (type: `parent-child`)

### Idempotency

The script is **idempotent** and safe to re-run:

1. Checks if item already imported by looking up `beadsId`
2. If exists: skips (shows `â­ï¸` in logs)
3. If new: inserts and records mapping

This means:
- âœ… Can run multiple times safely (no duplicates)
- âœ… Can wipe DB tables and re-run from scratch
- âœ… Partial failures don't block entire import

## Running the Import

### Option 1: Standard Import (Recommended)

```bash
cd backend-tsklets/api
npm run db:import:beads
```

This will:
1. âœ… Connect to PostgreSQL
2. âœ… Find "Tasklets" product
3. âœ… Find ramesh@systech.com user
4. âœ… Read `.beads/issues.jsonl`
5. âœ… Import all epics, features, and tasks
6. âœ… Show detailed logs of progress
7. âœ… Verify counts in database

### Option 2: After Database Wipe

If you clear the database and want to re-import:

```bash
# 1. Drop all tables (using Drizzle or direct SQL)
npm run db:push  # Recreate schema

# 2. Seed essential data
npm run db:seed

# 3. Create Tasklets product (via app UI or seed)

# 4. Re-import Beads
npm run db:import:beads
```

## Output Example

```
ğŸš€ Starting Beads Import...

ğŸ“¦ Finding Tasklets product...
âœ… Found product: Tasklets (ID: 1)

ğŸ‘¤ Finding ramesh@systech.com user...
âœ… Found user: Ramesh Babu (ID: 5)

ğŸ“– Reading .beads/issues.jsonl...
âœ… Loaded 85 issues

ğŸ“Š Issue breakdown:
   Epics: 10
   Features: 13
   Tasks: 10

ğŸ“Œ Importing Epics...
   âœ… tsklets-8cz â†’ Epic 1
   âœ… tsklets-8he â†’ Epic 2
   ...

ğŸ“Œ Importing Features...
   âœ… tsklets-ypa â†’ Feature 1 (Epic 1)
   â­ï¸  tsklets-4rp (already imported)
   ...

ğŸ“Œ Importing Tasks...
   âœ… tsklets-cbt.1 â†’ Task 1 (Feature 1)
   ...

ğŸ“ˆ Import Summary:
   Epics imported: 10
   Features imported: 13
   Tasks imported: 10

ğŸ“Š Database Verification:
   Total Epics in DB: 10
   Total Features in DB: 13
   Total Tasks in DB: 10

âœ… Beads import complete!
```

## Troubleshooting

### Error: "Tasklets product not found!"
**Solution**: Create the "Tasklets" product in the app UI first, or add to seed data.

### Error: "ramesh@systech.com user not found!"
**Solution**: Create the user account via app signup or add to seed data.

### Error: "Failed to parse line..."
**Solution**: Check `.beads/issues.jsonl` is valid JSONL format (one JSON per line).

### Import hangs or takes forever
**Solution**: Check database connection and PostgreSQL service status:
```bash
# Test connection
psql postgresql://postgres:password@localhost:5432/tasklets -c "SELECT 1;"
```

### Partial import (some items failed)
**Solution**: Check console logs for which items failed. You can:
1. Fix the issue (e.g., missing product)
2. Re-run the import (idempotent, will skip existing items)
3. Manually fix failed items in the database

## Future: Bi-Directional Sync

This import script establishes the foundation for bi-directional sync:

- âœ… `beadsId` field links each tasklets item back to beads
- â³ Future: Watch for beads changes and sync back to tasklets
- â³ Future: Push tasklets status/priority changes back to beads

## Related Scripts

- `npm run db:seed` - Seed initial data (tenants, clients, users)
- `npm run db:seed:demo` - Seed demo data (included sample issues)
- `npm run db:push` - Apply database migrations
- `npm run db:studio` - Open Drizzle Studio for database inspection
