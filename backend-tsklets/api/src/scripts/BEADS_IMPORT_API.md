# Beads Import Script (API-Based)

This script imports epics, features, and tasks from Beads CLI (`.beads/issues.jsonl`) into the Tasklets application **via REST API calls** instead of direct database operations.

## Why API-Based?

âœ… **Tests the API** - Validates endpoints during import
âœ… **Realistic Flow** - Same path as real usage through UI
âœ… **Better Validation** - API handles data validation and constraints
âœ… **Error Handling** - HTTP errors show what went wrong
âœ… **Safe** - No direct database access needed

## Prerequisites

Before running the import, make sure:

1. **API server is running** - `npm run dev` (in another terminal)
2. **Database schema is up-to-date**: `npm run db:push`
3. **Tasklets product exists** in the database (created via app UI or seed)
4. **ramesh@systech.com user exists** with password `Systech@123` (or set via `BEADS_PASSWORD`)
5. **`.beads/issues.jsonl`** exists at repo root (generated by beads CLI)

## How It Works

### Authentication Flow

```
1. Reads .beads/issues.jsonl
2. Authenticates: POST /api/auth/signin (ramesh@systech.com)
3. Gets JWT token â†’ includes in all subsequent requests
4. Creates items via authenticated API endpoints
```

### Data Flow

```
.beads/issues.jsonl â†’ Fetch /api/products (get Tasklets)
                    â†“
                    POST /api/epics (create epics)
                    â†“
                    POST /api/features (create features, link to epics)
                    â†“
                    POST /api/tasks (create tasks, link to features)
```

### API Endpoints Used

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/auth/signin` | POST | Get JWT token |
| `/api/products` | GET | Find "Tasklets" product ID |
| `/api/epics` | POST | Create epic |
| `/api/features` | POST | Create feature |
| `/api/tasks` | POST | Create task |

## Field Mappings

### Epic Mapping

| Beads | API Payload | Notes |
|-------|-------------|-------|
| `id` | metadata.beadsId | Stored in metadata for future sync |
| `title` | title | Issue title |
| `description` | description | Full description (empty string if missing) |
| `status` | status | Mapped: openâ†’backlog, in_progressâ†’in_progress, closedâ†’completed |
| `priority` | priority | Mapped: P0â†’0, P1â†’1, P2â†’2, P3â†’3, P4â†’4 |
| `labels` | labels | Array of tags |
| productId | productId | "Tasklets" product ID |

### Feature Mapping

| Beads | API Payload | Notes |
|-------|-------------|-------|
| `id` | metadata.beadsId | Stored in metadata |
| `title` | title | Issue title |
| `description` | description | Full description |
| `status` | status | Same mapping as epics |
| `priority` | priority | Same mapping as epics |
| `labels` | labels | Array of tags |
| epicId | epicId | Parent epic ID (from hierarchy) |

### Task Mapping

| Beads | API Payload | Notes |
|-------|-------------|-------|
| `id` | metadata.beadsId | Stored in metadata |
| `title` | title | Issue title |
| `description` | description | Full description |
| `status` | status | Mapped: openâ†’backlog, closedâ†’completed |
| `priority` | priority | Same mapping |
| `labels` | labels | Array of tags |
| `type` | type | Always "task" |
| featureId | featureId | Parent feature ID (from hierarchy) |

## Status Mapping

| Beads Status | Tasklets Status |
|--------------|-----------------|
| `open` | `backlog` |
| `in_progress` | `in_progress` |
| `closed` | `completed` |
| `pending_internal_review` | `backlog` |
| `resolved` | `completed` |
| Other | `backlog` (default) |

## Priority Mapping

| Beads | Tasklets |
|------|----------|
| P0 | 0 (Critical) |
| P1 | 1 (High) |
| P2 | 2 (Medium) |
| P3 | 3 (Low) |
| P4 | 4 (Backlog) |

## Hierarchy Resolution

The script maintains the parent-child relationships from beads:

**Epics** are top-level, standalone items

**Features** are linked to parent Epic:
- Looks for dependency with type `parent-child`
- If found: uses that epic
- If not found: uses first imported epic (fallback)

**Tasks** are linked to parent Feature:
- Looks for dependency with type `parent-child`
- If found: uses that feature
- If not found: uses first imported feature (fallback)

## Running the Import

### Setup (Terminal 1)

```bash
cd backend-tsklets/api

# Make sure DB is ready
npm run db:push

# Start the API server
npm run dev
```

Wait for output like:
```
âœ¨ Server running on port 4030
```

### Import (Terminal 2)

```bash
cd backend-tsklets/api

# Run the import
npm run db:import:beads:api
```

Optional: Set custom password if different from seed default:

```bash
BEADS_PASSWORD="your-password" npm run db:import:beads:api
```

## Output Example

```
ğŸš€ Starting Beads Import via API...

ğŸ” Authenticating as ramesh@systech.com...
âœ… Authenticated successfully (User ID: 5)

ğŸ“¦ Finding "Tasklets" product...
âœ… Found product: Tasklets (ID: 1)

ğŸ“– Reading .beads/issues.jsonl...
âœ… Loaded 85 issues

ğŸ“Š Issue breakdown:
   Epics: 10
   Features: 13
   Tasks: 10

ğŸ“Œ Importing Epics...
   âœ… tsklets-8cz â†’ Epic 1
   âœ… tsklets-8he â†’ Epic 2
   âœ… tsklets-3ss â†’ Epic 3
   ...

ğŸ“Œ Importing Features...
   âœ… tsklets-ypa â†’ Feature 1 (Epic 1)
   âœ… tsklets-0ra â†’ Feature 2 (Epic 1)
   ...

ğŸ“Œ Importing Tasks...
   âœ… tsklets-cbt.1 â†’ Task 1 (Feature 1)
   âœ… tsklets-cbt.1.1 â†’ Task 2 (Feature 1)
   ...

ğŸ“ˆ Import Summary:
   Epics created: 10
   Features created: 13
   Tasks created: 10

âœ… Beads import complete!
```

## Troubleshooting

### Error: "API Error 401: Invalid credentials"

**Cause**: Wrong password for `ramesh@systech.com`

**Solution**: Check the user's password in seed data, or set via environment variable:
```bash
BEADS_PASSWORD="correct-password" npm run db:import:beads:api
```

### Error: "Product 'Tasklets' not found"

**Cause**: Product doesn't exist in database

**Solution**: Create it via app UI or add to seed data:
```sql
INSERT INTO products (tenant_id, name, code) VALUES (1, 'Tasklets', 'TSKLTS');
```

### Error: "API Error 500: Epic not found"

**Cause**: Trying to create a feature but parent epic doesn't exist

**Solution**: Check that epics were created successfully. May indicate:
- Epic creation failed (check API logs)
- Hierarchy/dependencies not correctly resolved

### Error: "Connection refused"

**Cause**: API server not running

**Solution**: Start the API server in another terminal:
```bash
npm run dev
```

### Error: "ENOENT: no such file or directory"

**Cause**: `.beads/issues.jsonl` not found

**Solution**: Generate beads export:
```bash
bd export  # or check .beads/issues.jsonl exists
```

### Partial Import (Some items failed)

**Cause**: Some items failed to create while others succeeded

**Solution**: Check API logs for error details. Re-running the script will:
1. Skip successfully created items (idempotent via beadsId in metadata)
2. Retry failed items

## How to Verify

After import completes, verify in the app:

1. **Internal Portal** â†’ Products â†’ Tasklets
2. Should see:
   - 10 Epics
   - 13 Features (nested under epics)
   - 10 Tasks (nested under features)

Or via API:
```bash
# Get products
curl -H "Authorization: Bearer <token>" http://localhost:4030/api/products

# Get epics
curl -H "Authorization: Bearer <token>" http://localhost:4030/api/epics?productId=1

# Get features
curl -H "Authorization: Bearer <token>" http://localhost:4030/api/features?epicId=1

# Get tasks
curl -H "Authorization: Bearer <token>" http://localhost:4030/api/tasks?featureId=1
```

## Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `BEADS_PASSWORD` | `Systech@123` | Password for ramesh@systech.com |

## Database Cleanup

To start fresh:

```bash
# Option 1: Truncate specific tables
psql $DATABASE_URL -c "TRUNCATE epics, features, dev_tasks CASCADE;"

# Option 2: Full database reset
npm run db:reset

# Then re-run import
npm run db:import:beads:api
```

## vs Direct DB Import

| Aspect | API-Based | Direct DB |
|--------|-----------|-----------|
| Security | âœ… Authenticated | âŒ Direct access |
| Validation | âœ… API validates | âŒ Minimal |
| Error Messages | âœ… Clear HTTP errors | âŒ DB errors |
| Testability | âœ… Tests endpoints | âŒ No API test |
| Dependencies | âŒ Requires API running | âœ… Direct connection |
| Speed | âŒ Slower (network) | âœ… Faster (DB) |

## Future Enhancements

- [ ] Resume on network failure (checkpoint system)
- [ ] Batch creation (POST /api/epics/batch)
- [ ] Update beadsId on existing items (re-link)
- [ ] Webhooks for real-time sync
- [ ] Reverse sync (tasklets â†’ beads)
